version: 2

container_config: &container_config
  docker:
    - image: mcdonaldmike/docker-azure:stable
  working_directory: /usr/local/lib
cache_key: &cache_key
  docker_cache
restore_cache: &restore_cache
  restore_cache:
    name: Restore cache
    key: *cache_key

jobs:
  build_image:
    <<: *container_config
    steps:
      - checkout
      - setup_remote_docker
      - setup_remote_docker:
          docker_layer_caching: true
      - run:
          name: Build docker image
          command: |
            docker build -t $IMAGE_NAME .
      - run:
          name: Test docker image
          command: |
            docker run $IMAGE_NAME version |grep '1.10.2'
      - run:
          name: Save docker image
          command: |
            mkdir -p docker-cache
            docker save -o docker-cache/image.tar $IMAGE_NAME:$CIRCLE_BRANCH
      - save_cache:
          key: *cache_key
          paths:
            - docker-cache

  deploy_image:
    <<: *container_config
    steps:
      - *restore_cache
      - setup_remote_docker
      - checkout
      - run:
          name: Login to Azure
          command: |
            az login --service-principal -u $AZURE_CLIENT_ID -p $AZURE_CLIENT_SECRET --tenant $AZURE_TENANT_ID
      - run:
          name: Login to Azure Container Registry
          command: |
            az acr login --name $AZURE_CONTAINER_REPOSITORY
      - run:
          name: Load docker image
          command: |
            docker load < docker-cache/image.tar
      - run:
          name: Push image to Azure Container Registry
          command: |
            docker push $IMAGE_NAME
workflows:
  version: 2
  build_and_deploy:
    jobs:
      - build_image
      - deploy_image

